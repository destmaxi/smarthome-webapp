version: "3"
services:
  proxy:
    build: ./proxy
    ports:
      - "3000:80"
    networks:
      - backend
    depends_on:
      - user
      - room
      - device
      - action

  mosquitto:
    image: "eclipse-mosquitto:latest"
    ports:
      - "1880:1883"
    volumes:
      - ./mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf
    networks:
      - backend

  smarthome-db:
    image: "treehouses/couchdb"
    ports:
      - "3001:5984"
    networks:
      - backend

  user:
    build: ./user
    volumes:
      - ./user:/usr/src/user-service
      - ./boot-in-order.sh:/usr/src/user-service/boot-in-order.sh
      - ./func_to_string.js:/usr/src/user-service/func_to_string.js
      - ./gulpfile.js:/usr/src/user-service/gulpfile.js
      - ./daemon.js:/usr/src/user-service/src/daemon.js
      - /usr/src/user-service/node_modules
    environment:
      - NODE_ENV=development
    networks:
      - backend
    restart: on-failure
    depends_on:
      - smarthome-db

  action:
    build: ./action
    volumes:
      - ./action:/usr/src/action-service
      - ./boot-in-order.sh:/usr/src/action-service/boot-in-order.sh
      - ./func_to_string.js:/usr/src/action-service/func_to_string.js
      - ./gulpfile.js:/usr/src/action-service/gulpfile.js
      - ./daemon.js:/usr/src/action-service/src/daemon.js
      - /usr/src/action-service/node_modules
    environment:
      - NODE_ENV=development
    networks:
      - backend
    restart: on-failure

  device:
    build: ./device
    volumes:
      - ./device:/usr/src/device-service
      - ./boot-in-order.sh:/usr/src/device-service/boot-in-order.sh
      - ./func_to_string.js:/usr/src/device-service/func_to_string.js
      - ./gulpfile.js:/usr/src/device-service/gulpfile.js
      - ./daemon.js:/usr/src/device-service/src/daemon.js
      - /usr/src/device-service/node_modules
    environment:
      - NODE_ENV=development
    networks:
      - backend
    restart: on-failure
    depends_on:
      - smarthome-db

  room:
    build: ./room
    volumes:
      - ./room:/usr/src/room-service
      - ./boot-in-order.sh:/usr/src/room-service/boot-in-order.sh
      - ./func_to_string.js:/usr/src/room-service/func_to_string.js
      - ./gulpfile.js:/usr/src/room-service/gulpfile.js
      - ./daemon.js:/usr/src/room-service/src/daemon.js
      - /usr/src/room-service/node_modules
    environment:
      - NODE_ENV=development
    networks:
      - backend
    restart: on-failure
    depends_on:
      - smarthome-db

networks:
  backend:
    driver: overlay
